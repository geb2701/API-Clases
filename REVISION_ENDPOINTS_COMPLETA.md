# üîç Revisi√≥n Completa de Endpoints del Backend

## üìä Resumen de Controladores Encontrados

1. ‚úÖ **ProductController** - 14 endpoints
2. ‚úÖ **CategoryController** - 7 endpoints
3. ‚úÖ **OrderController** - 7 endpoints
4. ‚úÖ **UserController** - 7 endpoints
5. ‚úÖ **CartController** - 8 endpoints
6. ‚ùå **FileUploadController** - NO ENCONTRADO

**Total: 43 endpoints**

---

## üö® PROBLEMAS CR√çTICOS ENCONTRADOS

### 1. ‚ùå **FALTA `FileUploadController`**

**Problema:** El sistema necesita subir im√°genes, pero NO existe el controlador de archivos.

**Impacto:** 
- Las im√°genes de productos no se pueden subir
- El frontend llama a `/api/files/upload` pero el endpoint NO existe

**Soluci√≥n Necesaria:**
```java
@RestController
@RequestMapping("/files")
public class FileUploadController {
    @PostMapping("/upload")
    public ResponseEntity<FileUploadResponse> uploadFile(...) { ... }
    
    @GetMapping("/{fileName}")
    public ResponseEntity<Resource> downloadFile(...) { ... }
    
    @DeleteMapping("/{fileName}")
    public ResponseEntity<Void> deleteFile(...) { ... }
}
```

---

### 2. ‚ö†Ô∏è **Manejo de Errores Gen√©rico**

**Problema:** Todos los controladores devuelven `400 Bad Request` gen√©rico sin mensaje.

**Ejemplos:**
```java
// ‚ùå ProductController
catch (Exception e) {
    return ResponseEntity.badRequest().build(); // Sin mensaje!
}

// ‚ùå CategoryController
catch (Exception e) {
    return ResponseEntity.badRequest().build(); // Sin mensaje!
}

// ‚ùå UserController
catch (RuntimeException e) {
    return ResponseEntity.badRequest().build(); // Sin mensaje!
}
```

**Impacto:**
- El frontend no sabe qu√© sali√≥ mal
- Dificulta el debugging
- Mala experiencia de usuario

**Soluci√≥n Recomendada:**
```java
// ‚úÖ Mejorado
catch (Exception e) {
    return ResponseEntity.badRequest()
        .body(new ErrorResponse(e.getMessage()));
}

// O mejor a√∫n, usar @ExceptionHandler
@ExceptionHandler(ProductNotFoundException.class)
public ResponseEntity<ErrorResponse> handleProductNotFound(ProductNotFoundException e) {
    return ResponseEntity.status(404)
        .body(new ErrorResponse("Producto no encontrado: " + e.getMessage()));
}
```

---

### 3. ‚ö†Ô∏è **Endpoints Redundantes en `ProductController`**

**Problema:** Existen endpoints espec√≠ficos que duplican funcionalidad.

#### Redundancia 1: Ordenamiento
```java
// ‚ùå Endpoints redundantes
GET /api/products/sort/name?direction=asc
GET /api/products/sort/price?direction=desc

// ‚úÖ Ya existe esto (m√°s flexible):
GET /api/products?sortBy=name&sortDir=asc
GET /api/products?sortBy=price&sortDir=desc
```

**Recomendaci√≥n:** Eliminar `/sort/name` y `/sort/price`, usar solo el endpoint principal.

---

### 4. ‚ö†Ô∏è **Falta de Validaci√≥n de Par√°metros**

**Ejemplos:**

#### ProductController - `price-range`
```java
// ‚ùå Sin validaci√≥n
@GetMapping("/price-range")
public ResponseEntity<Page<Product>> getProductsByPriceRange(
    @RequestParam BigDecimal minPrice,
    @RequestParam BigDecimal maxPrice, ...) {
    
    // ¬øQu√© pasa si minPrice > maxPrice?
    // ¬øQu√© pasa si son negativos?
}
```

**Soluci√≥n:**
```java
// ‚úÖ Con validaci√≥n
if (minPrice.compareTo(maxPrice) > 0) {
    throw new IllegalArgumentException("minPrice debe ser <= maxPrice");
}
if (minPrice.compareTo(BigDecimal.ZERO) < 0) {
    throw new IllegalArgumentException("minPrice no puede ser negativo");
}
```

#### OrderController - `create-from-cart`
```java
// ‚ùå Sin validaciones
@PostMapping("/create-from-cart")
public ResponseEntity<Order> createOrderFromCart(@RequestBody CreateOrderRequest request) {
    // No valida si sessionId existe
    // No valida si userId es v√°lido
    // No valida si el carrito est√° vac√≠o
}
```

---

### 5. ‚ö†Ô∏è **CORS Duplicado en Cada Controlador**

**Problema:** Cada controlador tiene su propia configuraci√≥n CORS.

```java
// ‚ùå Repetido en TODOS los controladores
@CrossOrigin(origins = { "http://localhost:3000", "http://localhost:5173" })
```

**Problemas:**
- Si cambias el puerto, hay que actualizarlo en 5+ archivos
- Inconsistencias potenciales

**Soluci√≥n Recomendada:**
```java
// ‚úÖ Configuraci√≥n global en SecurityConfig
@Configuration
public class SecurityConfig {
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(List.of(
            "http://localhost:5173",
            "http://localhost:3000"
        ));
        configuration.setAllowedMethods(List.of("*"));
        configuration.setAllowedHeaders(List.of("*"));
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

Luego **eliminar** `@CrossOrigin` de TODOS los controladores.

---

### 6. ‚ö†Ô∏è **DTOs Internos en Controladores**

**Problema:** Los DTOs (Data Transfer Objects) est√°n dentro de los controladores.

```java
// ‚ùå En OrderController
public static class CreateOrderRequest { ... }
public static class UpdateStatusRequest { ... }

// ‚ùå En UserController
public static class LoginRequest { ... }
public static class EmailCheckRequest { ... }
```

**Problemas:**
- Dificulta la reutilizaci√≥n
- Viola principio de responsabilidad √∫nica
- No se pueden validar con `@Valid` correctamente

**Soluci√≥n:**
```
src/main/java/grupo7/ecommerceapi/
‚îú‚îÄ‚îÄ controller/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ request/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateOrderRequest.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UpdateStatusRequest.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoginRequest.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EmailCheckRequest.java
‚îÇ   ‚îî‚îÄ‚îÄ response/
‚îÇ       ‚îú‚îÄ‚îÄ OrderResponse.java
‚îÇ       ‚îú‚îÄ‚îÄ UserResponse.java
‚îÇ       ‚îî‚îÄ‚îÄ ErrorResponse.java
```

---

### 7. ‚ö†Ô∏è **Exponer Contrase√±as en Respuestas**

**PROBLEMA CR√çTICO DE SEGURIDAD:**

```java
// ‚ùå UserController
@PostMapping("/login")
public ResponseEntity<User> loginUser(...) {
    Optional<User> user = userService.login(...);
    return user.map(ResponseEntity::ok) // ¬°Devuelve User con password!
}
```

**Impacto:**
- La contrase√±a (incluso hasheada) se env√≠a al frontend
- Exposici√≥n de datos sensibles

**Soluci√≥n:**
```java
// ‚úÖ User entity
@JsonIgnore
private String password;

// O mejor, usar DTOs
public class UserResponse {
    private Long id;
    private String name;
    private String email;
    // Sin password!
}
```

---

### 8. ‚ö†Ô∏è **Respuestas HTTP Incorrectas**

#### Problema 1: Crear con `200 OK`
```java
// ‚ùå ProductController
@PostMapping
public ResponseEntity<Product> createProduct(...) {
    Product createdProduct = productService.createProduct(product);
    return ResponseEntity.ok(createdProduct); // Deber√≠a ser 201 Created
}
```

**Correcci√≥n:**
```java
// ‚úÖ Correcto
return ResponseEntity.status(HttpStatus.CREATED)
    .body(createdProduct);
```

#### Problema 2: `400` cuando deber√≠a ser `409 Conflict`
```java
// ‚ùå CategoryController
if (categoryService.existsByName(category.getName())) {
    return ResponseEntity.badRequest().build(); // Deber√≠a ser 409
}
```

**Correcci√≥n:**
```java
// ‚úÖ Correcto
return ResponseEntity.status(HttpStatus.CONFLICT)
    .body(new ErrorResponse("La categor√≠a ya existe"));
```

---

### 9. ‚ö†Ô∏è **Falta de Paginaci√≥n Consistente**

**Problema:** Algunos endpoints tienen paginaci√≥n, otros no.

```java
// ‚ùå Sin paginaci√≥n
@GetMapping("/low-stock")
public ResponseEntity<List<Product>> getLowStockProducts(...) {
    List<Product> products = ...
    return ResponseEntity.ok(products); // ¬øY si hay 10,000 productos?
}

// ‚úÖ Con paginaci√≥n
@GetMapping
public ResponseEntity<Page<Product>> getAllProducts(Pageable pageable) {
    ...
}
```

**Recomendaci√≥n:** Todos los endpoints que devuelven listas deber√≠an soportar paginaci√≥n.

---

### 10. ‚ö†Ô∏è **Falta AuthController**

**Problema:** La autenticaci√≥n est√° en `UserController` mezclada con gesti√≥n de usuarios.

```java
// ‚ùå En UserController
@PostMapping("/register")
@PostMapping("/login")
```

**Recomendaci√≥n:** Separar en `AuthController`:
```
/api/auth/register
/api/auth/login
/api/auth/logout
/api/auth/refresh
```

Y dejar en `UserController` solo:
```
/api/users          (GET, gesti√≥n)
/api/users/{id}     (GET, PUT, DELETE)
```

---

## üìã LISTA COMPLETA DE ENDPOINTS

### ProductController (14 endpoints)

| M√©todo | Endpoint | Estado | Notas |
|--------|----------|--------|-------|
| GET | `/products` | ‚úÖ | Principal, con paginaci√≥n |
| GET | `/products/{id}` | ‚úÖ | OK |
| GET | `/products/category/{categoryName}` | ‚úÖ | OK |
| GET | `/products/search?q=...` | ‚úÖ | OK |
| GET | `/products/category/{cat}/search?q=...` | ‚úÖ | OK |
| GET | `/products/offers` | ‚úÖ | OK |
| GET | `/products/price-range?min&max` | ‚ö†Ô∏è | Falta validaci√≥n |
| GET | `/products/sort/name` | ‚ùå | **REDUNDANTE** |
| GET | `/products/sort/price` | ‚ùå | **REDUNDANTE** |
| POST | `/products` | ‚ö†Ô∏è | Devuelve 200 en vez de 201 |
| PUT | `/products/{id}` | ‚úÖ | OK |
| DELETE | `/products/{id}` | ‚úÖ | Soft delete OK |
| GET | `/products/{id}/stock` | ‚úÖ | OK |
| GET | `/products/low-stock?threshold` | ‚ö†Ô∏è | Sin paginaci√≥n |

### CategoryController (7 endpoints)

| M√©todo | Endpoint | Estado | Notas |
|--------|----------|--------|-------|
| GET | `/categories` | ‚úÖ | OK |
| GET | `/categories/{id}` | ‚úÖ | OK |
| GET | `/categories/name/{name}` | ‚úÖ | OK |
| GET | `/categories/search?q=...` | ‚úÖ | OK |
| POST | `/categories` | ‚ö†Ô∏è | Devuelve 400 en vez de 409 |
| PUT | `/categories/{id}` | ‚úÖ | OK |
| DELETE | `/categories/{id}` | ‚úÖ | Soft delete OK |

### OrderController (7 endpoints)

| M√©todo | Endpoint | Estado | Notas |
|--------|----------|--------|-------|
| GET | `/orders/user/{userId}` | ‚úÖ | OK |
| GET | `/orders/{orderId}` | ‚úÖ | OK |
| GET | `/orders/number/{orderNumber}` | ‚úÖ | OK |
| GET | `/orders/{orderId}/items` | ‚úÖ | OK |
| POST | `/orders/create-from-cart` | ‚ö†Ô∏è | Falta validaci√≥n |
| PUT | `/orders/{orderId}/status` | ‚úÖ | OK |
| GET | `/orders/status/{status}` | ‚úÖ | OK |

### UserController (7 endpoints)

| M√©todo | Endpoint | Estado | Notas |
|--------|----------|--------|-------|
| GET | `/users` | ‚ö†Ô∏è | Deber√≠a ser solo Admin |
| GET | `/users/{id}` | ‚ö†Ô∏è | Sin control de acceso |
| GET | `/users/email/{email}` | ‚ö†Ô∏è | Expone datos sensibles |
| POST | `/users/register` | ‚ö†Ô∏è | Deber√≠a estar en `/auth` |
| POST | `/users/login` | üö® | **EXPONE PASSWORD** |
| PUT | `/users/{id}` | ‚ö†Ô∏è | Sin validaci√≥n de permisos |
| DELETE | `/users/{id}` | ‚ö†Ô∏è | Deber√≠a ser solo Admin |
| POST | `/users/check-email` | ‚úÖ | OK |

### CartController (8 endpoints)

| M√©todo | Endpoint | Estado | Notas |
|--------|----------|--------|-------|
| GET | `/cart/{sessionId}` | ‚úÖ | OK |
| POST | `/cart/{sessionId}/add` | ‚úÖ | OK |
| PUT | `/cart/{sessionId}/update` | ‚úÖ | OK |
| DELETE | `/cart/{sessionId}/remove` | ‚úÖ | OK |
| DELETE | `/cart/{sessionId}/clear` | ‚úÖ | OK |
| GET | `/cart/{sessionId}/total` | ‚úÖ | OK |
| GET | `/cart/{sessionId}/count` | ‚úÖ | OK |
| GET | `/cart/{sessionId}/validate` | ‚úÖ | OK |

### FileUploadController ‚ùå **FALTA CREAR**

| M√©todo | Endpoint | Estado | Notas |
|--------|----------|--------|-------|
| POST | `/files/upload` | ‚ùå | **NO EXISTE** |
| GET | `/files/{fileName}` | ‚ùå | **NO EXISTE** |
| DELETE | `/files/{fileName}` | ‚ùå | **NO EXISTE** |

---

## üéØ PRIORIDADES DE CORRECCI√ìN

### üö® CR√çTICO (Arreglar YA)

1. ‚ùå **Crear `FileUploadController`** - Sin esto, no se pueden subir im√°genes
2. üö® **Agregar `@JsonIgnore` a User.password** - Seguridad cr√≠tica
3. ‚ö†Ô∏è **Separar autenticaci√≥n en `AuthController`**

### ‚ö†Ô∏è IMPORTANTE (Arreglar pronto)

4. ‚ö†Ô∏è **Mejorar manejo de errores** - Devolver mensajes √∫tiles
5. ‚ö†Ô∏è **Eliminar endpoints redundantes** (`/sort/name`, `/sort/price`)
6. ‚ö†Ô∏è **Mover DTOs a paquete separado**
7. ‚ö†Ô∏è **Centralizar configuraci√≥n CORS**

### üí° MEJORA (Cuando se pueda)

8. üí° Validaciones de par√°metros
9. üí° C√≥digos HTTP correctos (201 para crear, 409 para conflictos)
10. üí° Paginaci√≥n en todos los endpoints de listas
11. üí° Control de acceso/autorizaci√≥n

---

## üìÅ Estructura Recomendada

```
EcommerceApi/src/main/java/grupo7/ecommerceapi/
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.java         ‚Üê NUEVO (separar de User)
‚îÇ   ‚îú‚îÄ‚îÄ CartController.java         ‚Üê OK
‚îÇ   ‚îú‚îÄ‚îÄ CategoryController.java     ‚Üê Mejorar errores
‚îÇ   ‚îú‚îÄ‚îÄ FileUploadController.java   ‚Üê ‚ùå CREAR
‚îÇ   ‚îú‚îÄ‚îÄ OrderController.java        ‚Üê OK
‚îÇ   ‚îú‚îÄ‚îÄ ProductController.java      ‚Üê Eliminar redundantes
‚îÇ   ‚îî‚îÄ‚îÄ UserController.java         ‚Üê Mover auth a AuthController
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ request/                    ‚Üê NUEVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateOrderRequest.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoginRequest.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ response/                   ‚Üê NUEVO
‚îÇ       ‚îú‚îÄ‚îÄ UserResponse.java
‚îÇ       ‚îú‚îÄ‚îÄ ErrorResponse.java
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ entity/
‚îú‚îÄ‚îÄ repository/
‚îú‚îÄ‚îÄ service/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ GlobalExceptionHandler.java ‚Üê NUEVO
‚îî‚îÄ‚îÄ exception/                      ‚Üê NUEVO
    ‚îú‚îÄ‚îÄ ProductNotFoundException.java
    ‚îú‚îÄ‚îÄ CategoryAlreadyExistsException.java
    ‚îî‚îÄ‚îÄ ...
```

---

## ‚úÖ ENDPOINTS QUE EST√ÅN BIEN

- ‚úÖ CartController - Bien dise√±ado
- ‚úÖ Paginaci√≥n en ProductController (endpoint principal)
- ‚úÖ Soft deletes en Product y Category
- ‚úÖ B√∫squeda con query params
- ‚úÖ OrderController estructura general

---

## üìä RESUMEN FINAL

| Categor√≠a | Cantidad |
|-----------|----------|
| ‚úÖ Endpoints OK | 28 |
| ‚ö†Ô∏è Endpoints con issues menores | 12 |
| üö® Endpoints con issues cr√≠ticos | 3 |
| ‚ùå Endpoints faltantes | 3 |
| **TOTAL** | **46** |

---

## üöÄ PR√ìXIMOS PASOS

1. ‚ùå **Crear FileUploadController** (cr√≠tico)
2. üö® **Ocultar password en respuestas** (seguridad)
3. ‚ö†Ô∏è **Crear GlobalExceptionHandler** (mejor UX)
4. ‚ö†Ô∏è **Separar AuthController** (mejor organizaci√≥n)
5. üí° **Eliminar endpoints redundantes** (limpieza)

---

¬øQuieres que implemente alguna de estas correcciones? Recomiendo empezar por las **CR√çTICAS** üö®

